<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fjellstadbladet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Inter:wght@400;600;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #1a1a1a; scroll-behavior: smooth; }
        .serif { font-family: 'Playfair Display', serif; }
        .newspaper-title { font-family: 'Playfair Display', serif; font-size: clamp(2.5rem, 8vw, 4.5rem); letter-spacing: -2px; }
        
        /* Artikkelkort styling */
        .article-card { border: 2px solid black; border-radius: 20px; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; height: 100%; }
        .article-card:hover { transform: translateY(-8px); box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.15); }
        
        .bg-fjellstad-blue { background-color: #001f3f !important; color: white !important; }
        .bg-fjellstad-blue p, .bg-fjellstad-blue h2, .bg-fjellstad-blue h1 { color: white !important; }

        .tag-pill { background-color: #f3f4f6; color: #1f2937; padding: 6px 14px; border-radius: 9999px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .bg-fjellstad-blue .tag-pill { background-color: rgba(255,255,255,0.2); color: white; }

        .footer-dark { background-color: #001529; color: white; padding: 80px 0 40px 0; margin-top: 100px; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    </style>
</head>
<body>

    <header class="border-b border-gray-100 sticky top-0 bg-white/90 backdrop-blur-md z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="openTips()" class="bg-black text-white px-6 py-2 rounded-full font-black uppercase text-[10px] tracking-widest shadow-lg hover:scale-105 transition">Tips oss</button>
                <div id="live-clock" class="hidden md:block text-[10px] font-bold opacity-30 uppercase tracking-widest"></div>
            </div>
            <div id="auth-section">
                <button onclick="loginWithDiscord()" class="text-xs font-black uppercase tracking-widest hover:opacity-60 transition">Logg inn</button>
            </div>
        </div>
    </header>

    <div id="header-visuals" class="text-center py-16">
        <h1 class="newspaper-title italic underline decoration-2 underline-offset-8 cursor-pointer hover:opacity-80 transition" onclick="location.reload()">Fjellstadbladet</h1>
        <div class="inline-block bg-black text-[#d4af37] px-8 py-2 mt-8 text-[10px] font-black tracking-[0.5em] uppercase rounded-full">❧ Årets Mediehus 2026 ❧</div>
    </div>

    <main id="main-view" class="max-w-7xl mx-auto px-4 pb-20">
        <div id="admin-ui" class="hidden mb-12 p-8 bg-yellow-50 border-2 border-yellow-200 rounded-[30px] flex justify-between items-center shadow-sm">
            <div>
                <p class="text-[10px] font-black uppercase opacity-40 tracking-tighter">Redaktør-tilgang aktiv</p>
                <p id="admin-name" class="font-black text-xl"></p>
                <button onclick="logout()" class="text-[10px] underline font-bold opacity-50 hover:opacity-100">Logg ut av systemet</button>
            </div>
            <button onclick="openModal()" class="bg-black text-white px-8 py-4 rounded-2xl font-black text-xs uppercase shadow-lg hover:bg-red-600 transition">Lag ny sak</button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10" id="news-grid"></div>
    </main>

    <article id="article-view" class="hidden min-h-screen pb-20">
        <div class="max-w-3xl mx-auto px-4 pt-16">
            <button onclick="closeArticle()" class="mb-12 flex items-center gap-2 font-black text-xs uppercase opacity-40 hover:opacity-100 transition">
                <span>←</span> Tilbake til forsiden
            </button>
            
            <h1 id="view-title" class="serif text-5xl md:text-7xl font-bold mb-8 leading-[1.1]"></h1>
            <p id="view-lead" class="text-2xl md:text-3xl mb-12 italic border-l-4 border-current pl-8 opacity-80 leading-relaxed"></p>

            <div id="article-content-area" class="space-y-12 text-xl md:text-2xl leading-relaxed"></div>

            <div class="mt-24 pt-12 border-t border-gray-100">
                <div class="flex flex-col md:flex-row md:justify-between md:items-end gap-8">
                    <div class="space-y-2">
                        <p id="pub-date" class="text-sm font-bold opacity-50"></p>
                        <p id="upd-date" class="text-sm font-bold opacity-50"></p>
                        <p id="read-time" class="text-[10px] font-black uppercase tracking-widest opacity-30 italic"></p>
                    </div>
                    <div>
                        <p class="text-[10px] font-black uppercase tracking-widest opacity-30 mb-3">Emneknagger</p>
                        <div id="view-tags" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </article>

    <footer class="footer-dark">
        <div class="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-4 gap-12">
            <div>
                <h3 class="font-black uppercase text-xs mb-6 opacity-50 tracking-widest">Tips oss</h3>
                <ul class="space-y-3 text-sm">
                    <li class="cursor-pointer underline font-bold" onclick="openTips()">Send inn tips</li>
                    <li class="opacity-70">Tipstelefon: 05150</li>
                    <li class="opacity-70">tips@fjellstadbladet.no</li>
                </ul>
            </div>
            <div>
                <h3 class="font-black uppercase text-xs mb-6 opacity-50 tracking-widest">Kontakt</h3>
                <ul class="space-y-3 text-sm">
                    <li class="opacity-70">Kundesenter: 52 90 08 10</li>
                    <li class="opacity-70">Annonsering</li>
                    <li class="opacity-70">Brukervilkår</li>
                </ul>
            </div>
            <div>
                <h3 class="font-black uppercase text-xs mb-6 opacity-50 tracking-widest">Redaksjonen</h3>
                <ul class="space-y-3 text-sm">
                    <li>Sjefredaktør: <strong>Lisa Marie</strong></li>
                    <li class="opacity-70">Nyhetsredaktør: Per Person</li>
                </ul>
            </div>
            <div>
                <h3 class="font-black uppercase text-xs mb-6 opacity-50 tracking-widest">Adresse</h3>
                <ul class="space-y-3 text-sm opacity-70">
                    <li>Nykkebakken 2</li>
                    <li>4013 Fjellstad</li>
                </ul>
            </div>
        </div>
        <div class="max-w-7xl mx-auto mt-20 px-4 pt-10 border-t border-white/10 opacity-40 text-[9px] uppercase tracking-[0.3em] text-center">
            <p>© 2026 Fjellstadbladet – All kopiering av innhold er forbudt uten avtale.</p>
        </div>
    </footer>

    <div id="post-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-xl z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-[40px] p-8 md:p-12 max-w-3xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar relative shadow-2xl">
            <h2 id="modal-title" class="serif text-4xl font-bold mb-10">Opprett sak</h2>
            
            <div class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="text-[10px] font-black uppercase opacity-40 mb-2 block">Journalist</label>
                        <select id="author-select" class="w-full border-2 border-gray-100 p-4 rounded-2xl bg-gray-50 outline-none focus:border-black transition"></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase opacity-40 mb-2 block">Stil/Bakgrunn</label>
                        <select id="bg-select" class="w-full border-2 border-gray-100 p-4 rounded-2xl bg-gray-50 outline-none focus:border-black transition">
                            <option value="white">Hvit (Standard)</option>
                            <option value="blue">Mørkeblå (Breaking)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase opacity-40 mb-2 block">Kategori</label>
                        <select id="tag-select" class="w-full border-2 border-gray-100 p-4 rounded-2xl bg-gray-50 outline-none focus:border-black transition">
                            <option value="Fjellstad">Fjellstad</option>
                            <option value="Nyhet">Nyhet</option>
                            <option value="Blålys">Blålys</option>
                            <option value="Sport">Sport</option>
                            <option value="Kultur">Kultur</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-4">
                    <input type="text" id="t-in" placeholder="Tittel på saken" class="w-full text-3xl font-black border-b-4 border-gray-100 py-4 outline-none focus:border-red-600 transition placeholder:opacity-20">
                    <textarea id="l-in" placeholder="Ingress (den fete teksten under tittelen)..." class="w-full text-xl border-b-2 border-gray-100 py-4 outline-none focus:border-black transition h-24 resize-none placeholder:opacity-20"></textarea>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-[30px] border-2 border-dashed border-gray-200">
                    <p class="text-[10px] font-black uppercase opacity-40 mb-6 text-center">Artikkelinnhold</p>
                    <div id="content-builder" class="space-y-4 mb-8"></div>
                    <div class="flex gap-4">
                        <button onclick="addBlock('text')" class="flex-1 bg-white border-2 border-gray-200 py-4 rounded-2xl font-black text-[10px] uppercase hover:border-black transition">+ Legg til tekst</button>
                        <button onclick="addBlock('image')" class="flex-1 bg-white border-2 border-gray-200 py-4 rounded-2xl font-black text-[10px] uppercase hover:border-black transition">+ Legg til bilde-URL</button>
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button onclick="publish()" id="publish-btn" class="flex-[2] bg-red-600 text-white font-black py-6 rounded-3xl uppercase tracking-widest text-sm shadow-xl hover:bg-black transition">Lagre og publiser</button>
                    <button onclick="closeModal()" class="flex-1 bg-gray-100 rounded-3xl font-black uppercase text-[10px] tracking-widest">Avbryt</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://joyxkghutpwxrleafaxv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpveXhrZ2h1dHB3eHJsZWFmYXh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODE4ODIsImV4cCI6MjA4NDA1Nzg4Mn0.Y25J6145yZmDzzwly-o2BXqmojL1nkFv5GieA6oGZik';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const JOURNALISTS = [
            { name: "Camilla Bjørheim", img: "https://i.pravatar.cc/150?u=camilla" },
            { name: "Lisa Marie", img: "https://i.pravatar.cc/150?u=lisamarie" },
            { name: "Fjellstad Redaksjon", img: "https://i.pravatar.cc/150?u=redaksjon" }
        ];

        let articles = [];
        let isAdmin = false;
        let contentBlocks = [];
        let editingId = null;

        window.onload = async () => {
            // Live klokke
            setInterval(() => {
                const now = new Date();
                document.getElementById('live-clock').innerText = now.toLocaleDateString('no-NO', {weekday: 'long', day: 'numeric', month: 'long'}) + " • " + now.toLocaleTimeString('no-NO', {hour: '2-digit', minute: '2-digit'});
            }, 1000);

            // Fyll admin-dropdowns
            const aSelect = document.getElementById('author-select');
            JOURNALISTS.forEach((j, i) => aSelect.innerHTML += `<option value="${i}">${j.name}</option>`);

            await fetchArticles();
            await checkUser();
            
            // Rydd URL
            if (window.location.hash.includes('access_token')) {
                window.history.replaceState(null, "", window.location.origin + window.location.pathname);
            }
        };

        async function checkUser() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (user && user.user_metadata.provider_id === '1158061375604662352') {
                isAdmin = true;
                document.getElementById('admin-ui').classList.remove('hidden');
                document.getElementById('admin-name').innerText = user.user_metadata.full_name.toUpperCase();
                document.getElementById('auth-section').innerHTML = `<span class="text-[10px] font-black uppercase bg-red-600 text-white px-4 py-2 rounded-full shadow-lg">Redaktørmodus</span>`;
                renderFrontPage();
            }
        }

        async function fetchArticles() {
            const { data } = await _supabase.from('articles').select('*').order('created_at', { ascending: false });
            if (data) { articles = data; renderFrontPage(); }
        }

        function renderFrontPage() {
            document.getElementById('news-grid').innerHTML = articles.map((art, i) => `
                <div class="article-card ${art.bg_color === 'blue' ? 'bg-fjellstad-blue' : 'bg-white'} ${i === 0 ? 'md:col-span-2' : ''}">
                    <div onclick="openArticle(${art.id})" class="cursor-pointer flex-grow group">
                        <div class="overflow-hidden">
                            <img src="${art.mainImg}" class="${i === 0 ? 'h-[550px]' : 'h-72'} w-full object-cover group-hover:scale-105 transition duration-700">
                        </div>
                        <div class="p-10">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-[10px] font-black uppercase tracking-widest opacity-40">${art.tags || 'NYHET'}</span>
                                <span class="w-1 h-1 bg-red-600 rounded-full"></span>
                                <span class="text-[10px] font-black uppercase tracking-widest opacity-40 italic">${Math.ceil((art.lead?.length + JSON.stringify(art.blocks).length) / 800)} min lesing</span>
                            </div>
                            <h2 class="serif ${i === 0 ? 'text-4xl md:text-6xl' : 'text-2xl md:text-3xl'} font-bold mb-6 group-hover:text-red-600 transition">${art.title}</h2>
                            <p class="opacity-70 line-clamp-3 text-lg leading-relaxed">${art.lead || ''}</p>
                        </div>
                    </div>
                    ${isAdmin ? `
                        <div class="p-4 flex gap-2 border-t border-black/5 bg-gray-50/50">
                            <button onclick='editArt(${JSON.stringify(art).replace(/'/g, "&apos;")})' class="flex-1 py-3 bg-white border border-black/10 rounded-xl text-[10px] font-black uppercase hover:bg-black hover:text-white transition">Rediger</button>
                            <button onclick="deleteArt(${art.id})" class="flex-1 py-3 bg-red-50 text-red-600 rounded-xl text-[10px] font-black uppercase hover:bg-red-600 hover:text-white transition">Slett</button>
                        </div>` : ''}
                </div>
            `).join('');
        }

        function openArticle(id) {
            const art = articles.find(a => a.id === id);
            const view = document.getElementById('article-view');
            view.className = `min-h-screen pb-20 transition-colors duration-500 ${art.bg_color === 'blue' ? 'bg-fjellstad-blue' : 'bg-white'}`;
            
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('header-visuals').classList.add('hidden');
            view.classList.remove('hidden');

            document.getElementById('view-title').innerText = art.title;
            document.getElementById('view-lead').innerText = art.lead || '';
            
            // Dato-oppsett
            const dateObj = new Date(art.created_at);
            const dateStr = dateObj.toLocaleDateString('no-NO', { day: 'numeric', month: 'long', year: 'numeric' });
            const timeStr = dateObj.toLocaleTimeString('no-NO', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('pub-date').innerText = `Publisert: ${dateStr} kl. ${timeStr}`;
            document.getElementById('upd-date').innerText = `Oppdatert: ${dateStr} kl. ${timeStr}`;
            document.getElementById('read-time').innerText = `Omtrent ${Math.ceil((art.lead?.length + JSON.stringify(art.blocks).length) / 800)} minutter lesetid`;

            // Journalist-profil (Automatisk plassert under første bilde)
            const author = art.author_data || JOURNALISTS[0];
            const authorHtml = `
                <div class="flex items-center gap-6 my-16 border-y-2 border-gray-100 py-10">
                    <img src="${author.img}" class="w-24 h-24 rounded-full border-4 border-black object-cover shadow-xl">
                    <div>
                        <p class="text-xs font-black uppercase tracking-widest opacity-40 mb-1">Journalist</p>
                        <p class="text-3xl font-black italic serif">Av ${author.name}</p>
                        <p class="text-sm opacity-60 font-medium">Fjellstadbladet Redaksjon</p>
                    </div>
                </div>`;

            // Innhold-prosessering
            let contentHtml = "";
            let imgCount = 0;
            art.blocks.forEach(b => {
                if (b.type === 'text') {
                    contentHtml += `<p class="mb-8 font-medium">${b.value}</p>`;
                } else {
                    contentHtml += `
                        <div class="my-12">
                            <img src="${b.value}" class="w-full rounded-[40px] border-2 border-black shadow-2xl">
                            <p class="text-[10px] font-black uppercase tracking-tighter mt-4 opacity-30 text-right">FOTO: REDAKSJONEN / FJELLSTADBLADET</p>
                        </div>`;
                    imgCount++;
                    if (imgCount === 1) contentHtml += authorHtml; // Setter inn journalist etter første bilde
                }
            });
            
            if (imgCount === 0) contentHtml = authorHtml + contentHtml; // Hvis ingen bilder, sett journalist øverst
            document.getElementById('article-content-area').innerHTML = contentHtml;

            // Tags
            const tagsArea = document.getElementById('view-tags');
            tagsArea.innerHTML = (art.tags || "Nyhet").split(',').map(t => `<span class="tag-pill">${t.trim()}</span>`).join('');

            window.scrollTo(0,0);
        }

        // --- ADMIN FUNKSJONER ---
        function addBlock(type) { contentBlocks.push({ type, value: '' }); renderBuilder(); }
        
        function renderBuilder() {
            document.getElementById('content-builder').innerHTML = contentBlocks.map((b, i) => `
                <div class="p-6 bg-white rounded-3xl border-2 border-gray-100 relative shadow-sm group">
                    <button onclick="contentBlocks.splice(${i}, 1); renderBuilder()" class="absolute top-4 right-4 text-red-500 font-black text-[10px] uppercase opacity-0 group-hover:opacity-100 transition">Fjern</button>
                    <p class="text-[9px] uppercase font-black opacity-30 mb-3 tracking-widest">${b.type === 'text' ? 'Tekstavsnitt' : 'Bilde-URL'}</p>
                    <textarea oninput="contentBlocks[${i}].value=this.value" class="w-full outline-none text-sm bg-transparent h-24 resize-none" placeholder="Skriv her...">${b.value}</textarea>
                </div>
            `).join('');
        }

        async function publish() {
            const btn = document.getElementById('publish-btn');
            btn.innerText = "Publiserer...";
            btn.disabled = true;

            const payload = {
                title: document.getElementById('t-in').value,
                lead: document.getElementById('l-in').value,
                blocks: contentBlocks,
                mainImg: contentBlocks.find(b => b.type === 'image')?.value || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=1200',
                author_data: JOURNALISTS[document.getElementById('author-select').value],
                tags: document.getElementById('tag-select').value,
                bg_color: document.getElementById('bg-select').value
            };

            if (editingId) await _supabase.from('articles').update(payload).eq('id', editingId);
            else await _supabase.from('articles').insert([payload]);
            
            location.reload();
        }

        function editArt(art) {
            editingId = art.id;
            document.getElementById('modal-title').innerText = "Rediger artikkel";
            document.getElementById('t-in').value = art.title;
            document.getElementById('l-in').value = art.lead;
            document.getElementById('tag-select').value = art.tags || "Nyhet";
            document.getElementById('bg-select').value = art.bg_color || "white";
            contentBlocks = JSON.parse(JSON.stringify(art.blocks));
            renderBuilder();
            openModal();
        }

        async function deleteArt(id) { if(confirm("Er du helt sikker på at du vil slette saken?")) { await _supabase.from('articles').delete().eq('id', id); location.reload(); } }

        // --- UI HELPERS ---
        function openModal() { document.getElementById('post-modal').classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
        function closeModal() { document.getElementById('post-modal').classList.add('hidden'); document.body.style.overflow = 'auto'; editingId = null; }
        function openTips() { document.getElementById('tips-modal').classList.remove('hidden'); }
        function closeTips() { document.getElementById('tips-modal').classList.add('hidden'); }
        function closeArticle() { location.reload(); }
        async function loginWithDiscord() { await _supabase.auth.signInWithOAuth({ provider: 'discord' }); }
        async function logout() { await _supabase.auth.signOut(); location.reload(); }
        function submitTips() { alert("Takk! Redaksjonen har mottatt ditt tips."); closeTips(); }
    </script>
</body>
</html>
