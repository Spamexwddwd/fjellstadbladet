<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fjellstadbladet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Inter:wght@400;600;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #1a1a1a; margin: 0; }
        .serif { font-family: 'Playfair Display', serif; }
        .newspaper-title { font-family: 'Playfair Display', serif; font-size: clamp(2.5rem, 8vw, 4.5rem); letter-spacing: -2px; }
        
        /* Artikkelkort styling */
        .article-card { 
            border: 2px solid black; 
            border-radius: 20px; 
            overflow: hidden; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            cursor: pointer;
        }
        .article-card:hover { transform: translateY(-8px); box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.15); }
        
        /* Farge-stiler */
        .bg-fjellstad-blue { background-color: #001f3f !important; color: white !important; }
        .bg-fjellstad-blue p, .bg-fjellstad-blue h2, .bg-fjellstad-blue h1 { color: white !important; }

        /* UI Elementer */
        .tag-pill { background-color: #f3f4f6; color: #1f2937; padding: 8px 16px; border-radius: 9999px; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .bg-fjellstad-blue .tag-pill { background-color: rgba(255,255,255,0.2); color: white; }
        
        .footer-dark { background-color: #001529; color: white; padding: 80px 0 40px 0; margin-top: 100px; }
        
        /* Input styling */
        input, select, textarea { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; outline: none; transition: border 0.2s; }
        input:focus { border-color: #000; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    </style>
</head>
<body>

    <header class="border-b border-gray-100 sticky top-0 bg-white/90 backdrop-blur-md z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <button onclick="openTips()" class="bg-black text-white px-6 py-2 rounded-full font-black uppercase text-[10px] tracking-widest shadow-lg hover:scale-105 transition">Tips oss</button>
                <div class="hidden md:block text-[10px] font-bold opacity-30 uppercase tracking-widest" id="live-clock"></div>
            </div>
            <div id="auth-section">
                <button onclick="loginWithDiscord()" class="text-xs font-black uppercase tracking-widest hover:opacity-60 transition">Logg inn</button>
            </div>
        </div>
    </header>

    <div id="header-visuals" class="text-center py-16">
        <h1 class="newspaper-title italic underline decoration-2 underline-offset-8 cursor-pointer hover:opacity-80 transition" onclick="location.reload()">Fjellstadbladet</h1>
        <div class="inline-block bg-black text-[#d4af37] px-8 py-2 mt-8 text-[10px] font-black tracking-[0.5em] uppercase rounded-full">❧ Siden 2024 ❧</div>
    </div>

    <main id="main-view" class="max-w-7xl mx-auto px-4 pb-20">
        <div id="admin-ui" class="hidden mb-12 p-8 bg-yellow-50 border-2 border-yellow-200 rounded-[30px] flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <p class="text-[10px] font-black uppercase text-yellow-700 tracking-tighter mb-1">Redaktørmodus aktiv</p>
                <h2 id="admin-name" class="text-2xl font-black"></h2>
                <button onclick="logout()" class="text-xs font-bold underline opacity-40 hover:opacity-100">Logg ut av systemet</button>
            </div>
            <button onclick="openModal()" class="bg-black text-white px-10 py-4 rounded-2xl font-black text-sm uppercase shadow-xl hover:bg-red-600 transition-colors">Opprett ny artikkel</button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-12" id="news-grid"></div>
    </main>

    <article id="article-view" class="hidden min-h-screen pb-32">
        <div class="max-w-3xl mx-auto px-4 pt-16">
            <button onclick="closeArticle()" class="mb-12 flex items-center gap-2 font-black text-xs uppercase opacity-40 hover:opacity-100 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                Tilbake til forsiden
            </button>
            
            <h1 id="view-title" class="serif text-5xl md:text-7xl font-bold mb-8 leading-[1.1]"></h1>
            <p id="view-lead" class="text-2xl md:text-3xl mb-12 italic border-l-8 border-black pl-8 opacity-80 leading-relaxed"></p>

            <div id="article-content-area" class="space-y-12 text-xl md:text-2xl leading-relaxed"></div>

            <div class="mt-24 pt-12 border-t-2 border-gray-100 space-y-10">
                <div class="space-y-2">
                    <p id="pub-date" class="font-bold text-sm opacity-60"></p>
                    <p id="upd-date" class="font-bold text-sm opacity-60"></p>
                </div>
                <div>
                    <p class="text-[10px] font-black uppercase tracking-widest opacity-30 mb-4">Emneknagger</p>
                    <div id="view-tags" class="flex flex-wrap gap-3"></div>
                </div>
            </div>
        </div>
    </article>

    <footer class="footer-dark">
        <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-4 gap-16">
            <div class="md:col-span-2">
                <h2 class="serif text-4xl font-bold mb-6">Fjellstadbladet</h2>
                <p class="opacity-60 max-w-sm leading-relaxed mb-8">Vi dekker alt som skjer i Fjellstad og omegn med fokus på sannhet, hurtighet og lokal stolthet.</p>
                <div class="flex gap-4">
                    <div class="w-10 h-10 bg-white/10 rounded-full"></div>
                    <div class="w-10 h-10 bg-white/10 rounded-full"></div>
                </div>
            </div>
            <div>
                <h3 class="font-black uppercase text-[10px] tracking-widest mb-6 opacity-40">Kontakt</h3>
                <ul class="space-y-4 text-sm font-medium">
                    <li>Nykkebakken 2, 4013</li>
                    <li class="hover:text-red-400 cursor-pointer">Sentralbord: 05150</li>
                    <li class="hover:text-red-400 cursor-pointer">redaksjonen@fjellstad.no</li>
                </ul>
            </div>
            <div>
                <h3 class="font-black uppercase text-[10px] tracking-widest mb-6 opacity-40">Tips oss</h3>
                <button onclick="openTips()" class="bg-white text-black px-6 py-3 rounded-xl font-black text-[10px] uppercase w-full">Send anonymt tips</button>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-6 mt-24 pt-8 border-t border-white/5 flex justify-between items-center text-[9px] font-bold uppercase tracking-widest opacity-30">
            <p>© 2026 Fjellstadbladet Media AS</p>
            <p>Ansvarlig redaktør: Lisa Marie</p>
        </div>
    </footer>

    <div id="post-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-xl z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-[40px] p-10 max-w-3xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar shadow-2xl">
            <div class="flex justify-between items-center mb-10">
                <h2 id="modal-title" class="serif text-4xl font-bold">Opprett Sak</h2>
                <button onclick="closeModal()" class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded-full font-bold">×</button>
            </div>
            
            <div class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase opacity-40">Journalist</label>
                        <select id="author-select" class="w-full bg-gray-50"></select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase opacity-40">Kategori (Tag)</label>
                        <select id="tag-select" class="w-full bg-gray-50"></select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase opacity-40">Bakgrunnsfarge</label>
                        <select id="bg-select" class="w-full bg-gray-50">
                            <option value="white">Hvit (Standard)</option>
                            <option value="blue">Mørkeblå (Spesiell)</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase opacity-40">Tittel</label>
                    <input type="text" id="t-in" class="w-full text-2xl font-bold" placeholder="Overskrift som fenger...">
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black uppercase opacity-40">Ingress</label>
                    <textarea id="l-in" class="w-full h-24 text-lg" placeholder="Kort oppsummering av saken..."></textarea>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-3xl border-2 border-dashed border-gray-200">
                    <p class="text-[10px] font-black uppercase opacity-40 mb-4">Artikkel-blokker</p>
                    <div id="content-builder" class="space-y-4 mb-6"></div>
                    <div class="flex gap-4">
                        <button onclick="addBlock('text')" class="flex-1 py-4 bg-white border-2 rounded-2xl font-black text-[10px] uppercase hover:bg-gray-100 transition">+ Tekstfelt</button>
                        <button onclick="addBlock('image')" class="flex-1 py-4 bg-white border-2 rounded-2xl font-black text-[10px] uppercase hover:bg-gray-100 transition">+ Bildefelt</button>
                    </div>
                </div>

                <button onclick="publish()" id="publish-btn" class="w-full bg-red-600 text-white font-black py-6 rounded-[25px] uppercase tracking-widest text-lg shadow-xl hover:bg-black transition">Publiser til Fjellstadbladet</button>
            </div>
        </div>
    </div>

    <div id="tips-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
        <div class="bg-white border-2 border-black rounded-[40px] p-10 max-w-md w-full">
            <h2 class="serif text-4xl font-bold mb-4">Tips oss</h2>
            <p class="mb-6 opacity-60 text-sm">Dine tips behandles konfidensielt.</p>
            <textarea id="tips-body" placeholder="Hva har skjedd?" class="w-full bg-gray-50 p-6 rounded-2xl h-40 outline-none mb-6 border-none"></textarea>
            <button onclick="submitTips()" class="w-full bg-black text-white font-black py-5 rounded-2xl uppercase tracking-widest shadow-lg">Send inn tips</button>
            <button onclick="closeTips()" class="w-full text-[10px] font-black uppercase opacity-30 mt-6 tracking-widest">Avbryt</button>
        </div>
    </div>

    <script>
        // --- SUPABASE SETUP ---
        const SUPABASE_URL = 'https://joyxkghutpwxrleafaxv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpveXhrZ2h1dHB3eHJsZWFmYXh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODE4ODIsImV4cCI6MjA4NDA1Nzg4Mn0.Y25J6145yZmDzzwly-o2BXqmojL1nkFv5GieA6oGZik';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- KONFIGURASJON ---
        const JOURNALISTS = [
            { name: "Camilla Bjørheim", img: "https://i.pravatar.cc/150?u=camilla" },
            { name: "Lisa Marie", img: "https://i.pravatar.cc/150?u=lisa" },
            { name: "Morten Stenberg", img: "https://i.pravatar.cc/150?u=morten" },
            { name: "Fjellstad Redaksjon", img: "https://i.pravatar.cc/150?u=fjell" }
        ];

        const TAG_OPTIONS = ["Fjellstad", "Nyhet", "Blålys", "Sport", "Kultur", "Næring", "Debatt"];

        let articles = [];
        let contentBlocks = [];
        let editingId = null;
        let isAdmin = false;

        // --- OPPSTART ---
        window.onload = async () => {
            // Fyll Dropdowns
            const aS = document.getElementById('author-select');
            JOURNALISTS.forEach((j, i) => aS.innerHTML += `<option value="${i}">${j.name}</option>`);
            
            const tS = document.getElementById('tag-select');
            TAG_OPTIONS.forEach(t => tS.innerHTML += `<option value="${t}">${t}</option>`);

            // Klokke
            setInterval(() => {
                const now = new Date();
                document.getElementById('live-clock').innerText = now.toLocaleDateString('no-NO', {weekday: 'long', day: 'numeric', month: 'long'}) + " • " + now.toLocaleTimeString('no-NO', {hour: '2-digit', minute: '2-digit'});
            }, 1000);

            // URL Vasker for Discord Login
            setInterval(() => {
                if(window.location.hash.includes('access_token')) window.history.replaceState(null, "", window.location.origin + window.location.pathname);
            }, 100);

            await fetchArticles();
            await checkUser();
        };

        async function checkUser() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (user && user.user_metadata.provider_id === '1158061375604662352') {
                isAdmin = true;
                document.getElementById('admin-ui').classList.remove('hidden');
                document.getElementById('admin-name').innerText = user.user_metadata.full_name.toUpperCase();
                document.getElementById('auth-section').innerHTML = `<span class="bg-black text-white px-4 py-1 rounded-full text-[9px] font-black uppercase">Redaktør</span>`;
            }
        }

        async function fetchArticles() {
            const { data } = await _supabase.from('articles').select('*').order('created_at', { ascending: false });
            if (data) { articles = data; renderFrontPage(); }
        }

        function renderFrontPage() {
            document.getElementById('news-grid').innerHTML = articles.map((art, i) => `
                <div class="article-card ${art.bg_color === 'blue' ? 'bg-fjellstad-blue' : 'bg-white'} ${i === 0 ? 'md:col-span-2' : ''}" onclick="openArticle(${art.id})">
                    <div class="relative overflow-hidden">
                        <img src="${art.mainImg}" class="${i === 0 ? 'h-[550px]' : 'h-72'} w-full object-cover hover:scale-105 transition duration-700">
                        <div class="absolute top-4 left-4 bg-white text-black px-4 py-1 rounded-full text-[10px] font-black uppercase">${art.tags || 'Nyhet'}</div>
                    </div>
                    <div class="p-10 flex flex-col flex-grow">
                        <h2 class="serif ${i === 0 ? 'text-5xl md:text-6xl' : 'text-2xl md:text-3xl'} font-bold mb-6">${art.title}</h2>
                        <p class="opacity-70 text-lg leading-relaxed line-clamp-3">${art.lead || ''}</p>
                        ${isAdmin ? `
                        <div class="mt-auto pt-8 flex gap-3" onclick="event.stopPropagation()">
                            <button onclick='editArt(${JSON.stringify(art)})' class="flex-1 py-3 border-2 border-current rounded-xl font-bold text-[10px] uppercase hover:bg-black hover:text-white transition">Rediger</button>
                            <button onclick="deleteArt(${art.id})" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold text-[10px] uppercase hover:bg-black transition">Slett</button>
                        </div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function openArticle(id) {
            const art = articles.find(a => a.id === id);
            const view = document.getElementById('article-view');
            view.className = `min-h-screen pb-32 ${art.bg_color === 'blue' ? 'bg-fjellstad-blue' : 'bg-white'}`;
            
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('header-visuals').classList.add('hidden');
            view.classList.remove('hidden');

            document.getElementById('view-title').innerText = art.title;
            document.getElementById('view-lead').innerText = art.lead || '';

            // Dato-formatering
            const opt = { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' };
            const rawDate = new Date(art.created_at);
            const pubDateStr = rawDate.toLocaleString('no-NO', opt).replace(',', '');
            document.getElementById('pub-date').innerText = `Publisert: ${pubDateStr.split(' ')[0]}. ${pubDateStr.split(' ')[1]} ${pubDateStr.split(' ')[2]} kl. ${pubDateStr.split(' ')[3]}`;
            document.getElementById('upd-date').innerText = `Oppdatert: ${pubDateStr.split(' ')[0]}. ${pubDateStr.split(' ')[1]} ${pubDateStr.split(' ')[2]} kl. ${pubDateStr.split(' ')[3]}`;
            
            document.getElementById('view-tags').innerHTML = `<span class="tag-pill">${art.tags || 'Fjellstad'}</span>`;

            // Innhold + Journalist-plassering
            const author = art.author_data || JOURNALISTS[0];
            const authorHtml = `
                <div class="flex items-center gap-6 my-12 border-y-2 border-gray-100 py-8">
                    <img src="${author.img}" class="w-20 h-20 rounded-full border-4 border-black object-cover">
                    <div>
                        <p class="font-black text-2xl">Av ${author.name}</p>
                        <p class="text-sm uppercase tracking-widest opacity-40 font-bold">Journalist i Fjellstadbladet</p>
                    </div>
                </div>`;

            let contentHtml = "";
            let authorInserted = false;
            art.blocks.forEach(b => {
                if (b.type === 'text') {
                    contentHtml += `<p class="mb-8">${b.value}</p>`;
                } else {
                    contentHtml += `<figure class="mb-10"><img src="${b.value}" class="w-full rounded-3xl border-2 border-black mb-2 shadow-2xl">
                                    <figcaption class="text-[10px] font-bold uppercase opacity-40 tracking-wider">Foto: Redaksjonen</figcaption></figure>`;
                    if (!authorInserted) { contentHtml += authorHtml; authorInserted = true; }
                }
            });
            if (!authorInserted) contentHtml = authorHtml + contentHtml;
            document.getElementById('article-content-area').innerHTML = contentHtml;
            window.scrollTo(0,0);
        }

        // --- ADMIN LOGIKK ---
        function addBlock(type) { contentBlocks.push({ type, value: '' }); renderBuilder(); }
        
        function renderBuilder() {
            document.getElementById('content-builder').innerHTML = contentBlocks.map((b, i) => `
                <div class="p-4 bg-white rounded-2xl border-2 relative">
                    <button onclick="contentBlocks.splice(${i}, 1); renderBuilder()" class="absolute top-2 right-2 text-red-500 font-bold">×</button>
                    <p class="text-[8px] font-black uppercase opacity-30 mb-2">${b.type}</p>
                    <textarea oninput="contentBlocks[${i}].value=this.value" class="w-full h-24 bg-transparent outline-none">${b.value}</textarea>
                </div>
            `).join('');
        }

        async function publish() {
            const btn = document.getElementById('publish-btn');
            btn.innerText = "Behandler...";
            btn.disabled = true;

            const payload = {
                title: document.getElementById('t-in').value,
                lead: document.getElementById('l-in').value,
                blocks: contentBlocks,
                mainImg: contentBlocks.find(b => b.type === 'image')?.value || 'https://via.placeholder.com/1200x800',
                author_data: JOURNALISTS[document.getElementById('author-select').value],
                tags: document.getElementById('tag-select').value,
                bg_color: document.getElementById('bg-select').value
            };

            if(editingId) await _supabase.from('articles').update(payload).eq('id', editingId);
            else await _supabase.from('articles').insert([payload]);
            location.reload();
        }

        function editArt(art) {
            editingId = art.id;
            document.getElementById('modal-title').innerText = "Rediger sak";
            document.getElementById('t-in').value = art.title;
            document.getElementById('l-in').value = art.lead;
            document.getElementById('tag-select').value = art.tags || "Nyhet";
            document.getElementById('bg-select').value = art.bg_color || "white";
            contentBlocks = JSON.parse(JSON.stringify(art.blocks));
            renderBuilder();
            openModal();
        }

        async function deleteArt(id) { if(confirm("Vil du slette saken for godt?")) { await _supabase.from('articles').delete().eq('id', id); location.reload(); } }

        // --- HJELPERE ---
        function openModal() { document.getElementById('post-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('post-modal').classList.add('hidden'); editingId = null; }
        function openTips() { document.getElementById('tips-modal').classList.remove('hidden'); }
        function closeTips() { document.getElementById('tips-modal').classList.add('hidden'); }
        function closeArticle() { document.getElementById('article-view').classList.add('hidden'); document.getElementById('main-view').classList.remove('hidden'); document.getElementById('header-visuals').classList.remove('hidden'); }
        async function loginWithDiscord() { await _supabase.auth.signInWithOAuth({ provider: 'discord' }); }
        async function logout() { await _supabase.auth.signOut(); location.reload(); }
        async function submitTips() { alert("Tips sendt inn til redaksjonen!"); closeTips(); }
    </script>
</body>
</html>
